---
title: "Airレジ API アーキテクチャ - 重要な設計変更"
type: api-documentation
status: active
created: "2025-10-14"
updated: "2025-10-14"
tags:
  - "project/airregi-analytics"
  - "integration/api"
---

# Airレジ API アーキテクチャ - 重要な設計変更

**更新日時**: 2025年10月13日 19:03
**ステータス**: 🔴 アーキテクチャ設計の見直しが必要

---

## 🔍 公式ドキュメントからの重要な発見

### データ連携の仕組み

公式ドキュメントの分析により、以下が判明しました：

#### **Push型（Webhook）方式の可能性が高い**

従来の想定（Pull型）:
```
本部システム → API呼び出し → Airレジサーバー → データ取得
```

実際の仕組み（Push型の可能性）:
```
Airレジ端末 → 精算完了 → Webhook送信 → 本部システム（受信）
```

### 公式ドキュメントの重要ポイント

1. **データ送信のタイミング**
   - 店舗での「精算」完了時
   - 「確認と精算」処理が完了した時点

2. **データ取得範囲**
   - 過去2ヶ月分のデータ
   - API利用開始後のデータが対象

3. **本部システム側の要件**
   - Airレジ APIに対応している必要がある
   - APIキー・トークンの設定が必要
   - **エンドポイントの用意が必要（推測）**

4. **複数店舗対応**
   - 店舗ごとに個別設定が必要
   - 各店舗でAPIキー・トークン発行

---

## 🏗️ 必要なアーキテクチャ変更

### 現在の実装（Pull型）

```python
# src/api/client.py
class AirRegiAPIClient:
    def get_transactions(self, start_date, end_date):
        # APIに対してリクエストを送信
        response = self.get('transactions', params=params)
        return response
```

**問題点**:
- Airレジ側にAPIエンドポイントが存在しない可能性
- Pull型ではなくPush型（Webhook）の可能性

### 必要な新規実装（Push型）

```python
# 新規: webhook_server.py
from flask import Flask, request

app = Flask(__name__)

@app.route('/webhook/airregi', methods=['POST'])
def receive_airregi_data():
    # Airレジからのデータ受信
    data = request.json

    # 認証チェック
    # データ保存
    # 分析処理トリガー

    return {"status": "ok"}
```

---

## 📋 新しいシステム設計案

### アーキテクチャ概要

```
┌─────────────┐
│  Airレジ端末 │
│  (店舗)     │
└──────┬──────┘
       │ 精算完了時
       │ Webhook送信
       ↓
┌─────────────────────┐
│ Webhook受信サーバー  │ ← 【新規実装が必要】
│ (本システム)        │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ データ保存          │
│ (data/raw/)        │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ データ分析          │ ← 【既存実装を活用】
│ (analyzer.py)      │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│ レポート生成        │ ← 【既存実装を活用】
│ (JSON/Excel)       │
└─────────────────────┘
```

### 必要な新規コンポーネント

#### 1. Webhookサーバー（Flask/FastAPI）
```python
# webhook_server.py
- Airレジからのデータ受信
- 認証検証（APIキー・トークン）
- データのバリデーション
- データ保存処理
```

#### 2. データ受信ハンドラー
```python
# src/webhook/handler.py
- Webhook受信処理
- データ整形
- ファイル保存
- 分析処理のトリガー
```

#### 3. 認証ミドルウェア
```python
# src/webhook/auth.py
- APIキー・トークンの検証
- 不正アクセスの防止
```

---

## 🔧 実装プラン

### Phase 1: Webhook受信サーバーの構築

#### 必要な追加パッケージ
```
Flask==3.0.0         # Webフレームワーク
gunicorn==21.2.0     # WSGIサーバー
```

#### ディレクトリ構造（追加分）
```
airregi-analytics/
├── webhook_server.py       # Webhookサーバーメイン
├── src/
│   └── webhook/
│       ├── __init__.py
│       ├── handler.py      # データ受信ハンドラー
│       ├── auth.py         # 認証ミドルウェア
│       └── validator.py    # データバリデーション
```

### Phase 2: 外部公開の準備

#### オプション1: ngrok（開発・テスト用）
```bash
# ngrokで一時的に外部公開
ngrok http 5000
```

#### オプション2: 本番サーバー
- VPS/クラウドサーバーへのデプロイ
- SSL証明書の設定（HTTPS必須）
- ファイアウォール設定

#### オプション3: クラウドサービス
- AWS Lambda + API Gateway
- Google Cloud Functions
- Azure Functions

### Phase 3: Airレジ側の設定

```
1. Webhookサーバーの公開URL取得
   例: https://your-domain.com/webhook/airregi

2. Airレジ バックオフィスで設定
   - データ連携API設定画面
   - Webhook URLの登録
   - APIキー・トークンの確認

3. テスト送信の実施
```

---

## ⚠️ 重要な確認事項

### 確認が必要な技術仕様

以下の情報が依然として不明です：

1. **Webhookのデータ形式**
   - JSON形式？
   - どのようなフィールド構造？
   - サンプルペイロード

2. **認証方式**
   - HTTPヘッダーでのAPIキー送信？
   - リクエストボディ内に含める？
   - 署名検証（HMAC等）の有無

3. **送信タイミング**
   - リアルタイム送信？
   - バッチ処理？
   - リトライ機能の有無

4. **エラーハンドリング**
   - 受信失敗時の再送信
   - タイムアウト設定
   - エラーコードの定義

### Airレジサポートへの問い合わせ推奨事項

```
件名: データ連携API - Webhook仕様について

お世話になります。
データ連携APIの実装を進めておりますが、
以下の技術仕様についてご教示ください。

1. データ送信方式
   - Webhook（Push型）でしょうか？
   - それともREST API（Pull型）でしょうか？

2. Webhookの場合の仕様
   - エンドポイントURLの登録方法
   - 送信されるデータ形式（JSON構造）
   - 認証方式の詳細
   - サンプルペイロード

3. REST APIの場合の仕様
   - APIエンドポイントURL
   - 利用可能なエンドポイント一覧
   - リクエスト・レスポンス例

4. 技術ドキュメント
   - 開発者向けドキュメントの入手方法
   - サンプルコード・実装例

よろしくお願いいたします。
```

---

## 🎯 次のアクションプラン

### 【最優先】仕様の明確化

#### ステップ1: サポートへ問い合わせ
- 上記の問い合わせ内容でAirレジサポートへ連絡
- 技術仕様書・開発者向けドキュメントの入手

#### ステップ2: 実装方針の決定
仕様確認後、以下のいずれかの方針を決定：

**A. Webhook方式の場合**
```
1. Webhookサーバー実装
2. 外部公開設定
3. Airレジ側で URL登録
```

**B. REST API方式の場合**
```
1. 既存のAPIクライアント調整
2. エンドポイントURL更新
3. 認証ヘッダー修正
```

### 暫定対応: 両方式対応の準備

仕様が不明な間は、両方式に対応できる構造を準備：

#### Webhook受信サーバーの先行実装
```bash
# 基本的なWebhookサーバーを実装
# 実際のデータ形式は後で調整可能な柔軟な設計
```

#### 既存のAPIクライアントの保持
```bash
# Pull型にも対応できるよう既存実装を維持
```

---

## 📊 現状の影響評価

### ✅ 再利用可能な既存実装

以下は**アーキテクチャに関わらず再利用可能**:

1. **データ分析エンジン** (`src/analysis/analyzer.py`)
   - データ形式さえ合えば、そのまま使用可能
   - 変更不要

2. **レポート生成**
   - JSON/Excel出力機能
   - 変更不要

3. **ログシステム** (`src/utils/logger.py`)
   - 変更不要

4. **環境設定**
   - 認証情報管理
   - 変更不要

### 🔄 要修正・追加の実装

1. **データ取得部分** (`src/api/client.py`)
   - Pull型の場合: エンドポイント調整のみ
   - Push型の場合: 新規Webhook実装が必要

2. **メインフロー** (`main.py`)
   - Webhook受信時の処理フロー追加
   - 既存の分析フローは維持

---

## 💡 推奨アプローチ

### フェーズ別実装戦略

#### Phase 1: 仕様確認（1-3日）
- [ ] Airレジサポートへ問い合わせ
- [ ] 技術仕様書入手
- [ ] 実装方針決定

#### Phase 2: Webhookサーバー実装（2-3日）
仕様がWebhook方式の場合:
- [ ] Flask/FastAPIサーバー実装
- [ ] 認証ミドルウェア実装
- [ ] データ受信ハンドラー実装
- [ ] ローカルテスト

#### Phase 3: 外部公開設定（1-2日）
- [ ] ngrokまたは本番サーバー準備
- [ ] SSL証明書設定
- [ ] セキュリティ設定

#### Phase 4: 統合テスト（2-3日）
- [ ] Airレジ側でURL登録
- [ ] テストデータ送信
- [ ] エンドツーエンドテスト
- [ ] 本番運用開始

---

## 📞 サポート・リソース

### Airレジサポート
- **FAQページ**: https://faq.airregi.jp/hc/ja/
- **問い合わせフォーム**: サポートページから

### 技術参考資料
- Flask公式: https://flask.palletsprojects.com/
- FastAPI公式: https://fastapi.tiangolo.com/
- ngrok公式: https://ngrok.com/

---

## 🔐 セキュリティ考慮事項

### Webhookサーバーのセキュリティ

1. **認証必須**
   - APIキー・トークンの検証
   - 不正アクセスの防止

2. **HTTPS必須**
   - SSL/TLS通信
   - 平文通信の禁止

3. **レート制限**
   - DoS攻撃対策
   - 異常なリクエストの検知

4. **ログ記録**
   - すべてのリクエストをログ
   - 不正アクセス試行の記録

---

**重要**: 正確な実装のため、必ずAirレジの公式技術仕様を確認してください。

---

## 関連ドキュメント

- [[API_SPECIFICATION]]
- [[GOOGLE_SHEETS_SETUP]]

